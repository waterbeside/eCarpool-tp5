{extend name="base" /}
{block name="body"}

<div class="amain-body P-department-list-dialog">
    <!--tab标签-->
    <div class="layui-tab layui-tab-brief" style="margin:0 0 30px ">
        <ul class="amain-tool-bar" >
            <li {php} echo !$deep ?  'class="layui-this"' : '';{/php}><a href="{:url('list_dialog')}"  >部门管理</a></li>
            <li {php} echo $deep ==1 ?  'class="layui-this"' : '';{/php}><a href="{:url('list_dialog',['pid'=>'p_1'])}"  >地区列表</a></li>
            <li {php} echo $deep ==3 ?  'class="layui-this"' : '';{/php}><a href="{:url('list_dialog',['pid'=>'p_3'])}"  >分公司列表</a></li>
        </ul>

        <div class="layui-tab-content">

            <div class="layui-tab-item layui-show">
              {php} if(!$deep){ {/php}
                <form class="layui-form layui-form-pane" action="{:url('admin/department/list_dialog')}" method="get">
                  <input type="hidden" name ="pid" value={$pid} />
                  <div class="my-input-prebox" style="width:100px">
                    <select name="filter[is_all]"  >
                      <option value="0" {php}echo isset($filter['is_all']) &&  $filter['is_all'] == 0  ? 'selected' : ''; {/php}>检索当前</option>
                      <option value="1" {php}echo !isset($filter['is_all']) ||  $filter['is_all'] ? 'selected' : ''; {/php}>检索全部</option>
                    </select>
                  </div>
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="text" name="filter[keyword]" value="{$filter['keyword'] ? $filter['keyword'] :''}" placeholder="关键词" class="layui-input" style="width:130px" >
                        </div>
                    </div>
                    <div class="layui-inline">
                        <button class="layui-btn"><i class="fa fa-search"></i></button>
                    </div>
                </form>
                <hr>
                {php} } {/php}

                <!-- 面包屑导行 -->
                <div class="layui-breadcrumb">
                  <?php if(count($path) >1){ foreach($path as $value){
                    if($pid != $value['id']){ ?>
                      <a href="{:url('list_dialog',['pid'=>$value['id']])}">{$value['name']}</a>
                  <?php  }else{ ?>
                    <a ><cite>{$value['name']}</cite></a>
                  <?php }}} ?>
                </div>
                <div class="blank10"> </div>
                <!-- /面包屑导行 -->


                <blockquote class="layui-elem-quote">共检得 <b>{$lists->total()}</b> 条数据</blockquote>
                <table lay-filter="listtable" class="layui-table">
                    <thead>
                    <tr>
                        <th lay-data="{field:'id', width:80}">ID</th>
                        <th lay-data="{field:'pid', width:80}">PID</th>
                        <th lay-data="{field:'name'}">名称</th>
                        <?php if($deep){ ?>
                        <th lay-data="{field:'fullname', width:120}">PATH</th>
                        <?php } ?>
                        <th lay-data="{field:'options', width:80,fixed:'right'}">操作</th>

                    </tr>
                    </thead>
                    <tbody>
                    {foreach name="lists" item="vo"}
                    <tr>
                        <td>{$vo.id}</td>
                        <td>{$vo.pid}</td>
                        <td><a href="{:url('list_dialog',['pid'=>$vo['id']])}">{$vo.name}</a></td>
                        <?php if($deep){ ?>
                        <td class="layui-breadcrumb">
                          <?php
                          $item_full_array = explode(',',$vo['fullname']);
                          $item_path_array = explode(',',$vo['path']);
                          foreach($item_full_array as $k => $p ){
                            $sep = $k ?  "/" : "";
                            $pid = isset($item_path_array[$k+1]) ? $item_path_array[$k+1] : '';
                            if($pid){
                              echo '<a href="'.url('list_dialog',['pid'=>$pid]).'">'.$p.'</a>';
                            }else{
                              echo '<a href="'.url('list_dialog',['pid'=>$vo['id']]).'"><cite><b >'.$p.'</b></cite></a>';
                            }
                          }
                          ?>
                        </td>
                        <?php } ?>
                        <td>

                          <?php
                            $returnItemData = [
                              'id'             => $vo['id'],
                              'name'           => $vo['name'],
                              'fullname'     => $vo['fullname'],
                              'path'           => $vo['path'],
                            ];
                          ?>
                            <button href="javascript:void(0);"  class="layui-btn   layui-btn-xs layui-btn-primary btn-select J-btn-{$vo.id}" title="选择" onclick='DialogList_EXEC.deptClickItem(<?php echo json_encode($returnItemData) ?>)'>选择</button>

                        </td>
                    </tr>
                    {/foreach}
                    </tbody>
                </table>
                <!--分页-->

                {$lists|raw}

            </div>
        </div>
    </div>
    <div class="am-bottom-tool-bar">
      <div class="J-selected-wrapper">
      </div>
      <div class="btns-wrapper">
        <a class="layui-btn layui-btn-primary layui-btn-sm" onclick="DialogList_EXEC.close()">取消</a>
        <a class="layui-btn   layui-btn-sm" onclick="DialogList_EXEC.done()">完成</a>
      </div>

    </div>
</div>
{/block}
{block name="script"}
<script>
  var DialogList_EXEC = {
    datas : {
      depts: [],
      deptsData: {},
    },
    init : function(){
      var _this = this;
      initLayuiTable({ limit: {$pagesize} });
      var old_data_str = MyCookies.get('department_selected_list');
      if(old_data_str){
        this.datas.deptsData = $.parseJSON(old_data_str);
      }

      if(this.datas.deptsData){
        var deptsData = this.datas.deptsData;
        for(var id in deptsData){
          _this.datas.depts.push(id);
          var itemHtml = _this.selectedTemplate(deptsData[id]);
          $('.J-selected-wrapper').append(itemHtml);
          $btn = $('.P-department-list-dialog .J-btn-'+id);
          $btn.addClass("checked");
        }
      }
    },
    /**
     * 重建 datas里的id列表
     */
    rebuildDeptIds: function(){
      var deptsData = this.datas.deptsData;
      this.datas.depts = [];
      for(var id in deptsData){
        this.datas.depts.push(id);
      }
    },
    /**
     * 已选项item模板
     */
    selectedTemplate: function(data){
      var html = '<div class="item" data-id="'+data.id+'" title="'+data.fullname+'"><span>'+data.name+'</span><a class="close" onclick="DialogList_EXEC.closeItem()"><i class="fa fa-close"></i></a></div>';
      return html;
    },
    /**
     * 点击选择时动作
     */
    deptClickItem : function(data){
      var e = e || event
      var $target = $(e.target);
      if($target.hasClass('checked')){
        return false;
      }
      var old_ids = this.datas.depts;
      var pathArray = data.path.split(',');
      var returnFalse = false;
      $(old_ids).each(function(index,item){
        if($.inArray(item,pathArray) >= 0){
          returnFalse = true;
          return false;
        }
      })
      if(returnFalse){
        layer.msg('您已选择部门的父级，请勿再选');
        return false;
      }
      $target.addClass('checked');
      var id = data.id;
      var deptsData = typeof(this.datas.deptsData) == "object"  ? this.datas.deptsData : {};
      deptsData[data.id] = {"id":data.id,"name":data.name,"fullname":data.fullname};
      //deptsData.push({"id":data.id,"name":data.name,"fullname":data.fullname});
      this.datas.deptsData = deptsData;
      this.rebuildDeptIds();

      var newDataString = JSON.stringify(deptsData);
      MyCookies.set('department_selected_list',newDataString);
      var itemHtml = this.selectedTemplate(data);
      $('.J-selected-wrapper').append(itemHtml);
    },
    /**
     * 关闭已选项功作
     */
    closeItem: function(){
      var e = e || event
      var $target = $(e.target);
      var $item = $target.closest('.item');
      var id = $item.data('id');
      $('.P-department-list-dialog .J-btn-'+id).removeClass('checked');
      var deptsData = typeof(this.datas.deptsData) == "object"  ? this.datas.deptsData : {};
      delete deptsData[id] ;
      this.datas.deptsData = deptsData;
      this.rebuildDeptIds();

      var newDataString = JSON.stringify(deptsData);
      MyCookies.set('department_selected_list',newDataString,600);

      $item.addClass('delete');
      setTimeout(function(){
        $item.remove();
      },400);
    },
    /**
     * 点击完成按钮
     * @return {[type]} [description]
     */
    done: function(){
      var data = {
        'id_list': this.datas.depts,
        'list': this.datas.deptsData
      }
      if(typeof(window.parent.FORM_PAGE_EXEC)!='object' || typeof(window.parent.FORM_PAGE_EXEC.<?php echo $fun ?>)!="function"){
        if(typeof(window.parent.<?php echo $fun ?>)!="function"){
          return false;
        }else{
          window.parent.<?php echo $fun."("; ?>data<?php echo ")"; ?>;
        }
      }else{
        window.parent.FORM_PAGE_EXEC.<?php echo $fun."("; ?>data<?php echo ")"; ?>;
      }
      this.close();
    },
    close: function(){
      MyCookies.delete('department_selected_list');
      var layerIndex = parent.layer.getFrameIndex(window.name);
      parent.layer.close(layerIndex);

    }
  }

  DialogList_EXEC.init();

</script>
{/block}
