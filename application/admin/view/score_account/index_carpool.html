{extend name="base" /}
{block name="body"}
<div class="amain-body">

    <!--tab标签-->
    <div class="layui-tab layui-tab-brief">

        <ul class="layui-tab-title amain-tool-bar" >
            <li class="layui-this"><a href="{:url('admin/scoreAccount/index',['type'=>2])}"  >Carpool帐号</a></li>
            <li class=""><a href="{:url('admin/scoreAccount/index',['type'=>0])}" >积分帐号</a></li>
        </ul>

        <div class="layui-tab-content">

                <form class="layui-form layui-form-pane" action="{:url('admin/scoreAccount/index',['type'=>2])}" method="get">
                    <div class="layui-inline">
                        <label class="layui-form-label">检索</label>
                        <div class="layui-input-inline">
                            <input type="text" name="keyword" value="{$keyword}" placeholder="请输入关键词" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <button class="layui-btn"><i class="fa fa-search"></i></button>
                    </div>
                </form>
                <hr>

                <table lay-filter="listtable" class="layui-table list-table">
                    <thead>
                    <tr >
                        <th lay-data="{field:'uid', width:80,fixed: 'left' }" >#</th>
                        <th lay-data="{field:'loginname', width:100, fixed: 'left'}">用户名</th>
                        <th lay-data="{field:'name' }">姓名</th>
                        <th lay-data="{field:'score', width:80}">分</th>
                        <th lay-data="{field:'phone', width:100}">手机</th>
                        <th lay-data="{field:'Department', width:100}">部门</th>
                        <th lay-data="{field:'company_name', width:100}">公司</th>
                        <th lay-data="{field:'other', width:60}">...</th>
                        <th lay-data="{field:'options', width:150,fixed: 'right'}">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    {foreach name="lists" item="vo"}
                    <tr class="account-list-item" data-id="{$vo.uid}" data-account="{$vo.loginname}">
                        <td>{$vo.uid}</td>
                        <td>{$vo.loginname}</td>
                        <td>{$vo.name}</td>
                        <td class="field-score"><span></span></td>
                        <td>{$vo.phone}</td>
                        <td>{$vo.Department}</td>
                        <td>{php}echo $vo['companyname'] ? $vo['companyname'].' / ' : '';{/php}{$vo.company_name}</td>

                        <!-- <td><a  class="layui-btn layui-btn-normal layui-btn-xs " data-title="分数管理"  data-trigger="modal" href="">0</a></td> -->
                        <td>
                          {php}echo $vo['is_active']==1 ? '' : '<i class="fa fa-times"></i>';{/php}
                          {php}echo $vo['sex']==1 ? '<i class="fa fa-mars"></i>' : ($vo['sex']==2 ? '<i class="fa fa-venus"></i>' : '<i class="fa fa-genderless"></i>' );{/php}
                        </td>
                        <td>
                          <a onclick="openLayer('{:url('admin/score/edit',['type'=>'carpool','uid'=>$vo['uid']])}','加减分');" href="javascript:void(0);"  class="layui-btn   layui-btn-xs "  title="加减分">加减分</a>
                          <a onclick="openLayer('{:url('admin/scoreHistory/index',['type'=>'carpool','account'=>$vo['loginname']])}','积分历史');" href="javascript:void(0);"  class="layui-btn  layui-btn-primary layui-btn-xs "  title="加减分">积分历史</a>
                        </td>
                    </tr>
                    {/foreach}
                    </tbody>
                </table>
                <!--分页-->
                {$lists|raw}

        </div>
    </div>
</div>

{/block}
{block name="script"}
<script>
var RESOLVE_INIT = {
  data : {
    list:<?php echo json_encode(json_decode(json_encode($lists),true)["data"]) ?>,
    pagesize:{$pagesize},
    tableHeight: "auto"
  },
  init:function(){
    var _this = this;
    var win_height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
    this.tableHeight = win_height - 190 > 400 ? win_height-190 : "auto";

    this.renderTable();

     $('.account-list-item').each(function(index, el) {

       // console.log(_this.data.list[index]);
       var account = $(el).data('account');
       _this.loadScoreAccount(account,function(res){
         var balance = res.data ? res.data : "-";
           $(el).find(".field-score span").html(balance);
           _this.renderTable();
       })
     });


  },

  renderTable: function(){
    initLayuiTable({
       limit: this.data.pagesize,
       cellMinWidth:200,
       height:this.tableHeight,
       /*data: this.data.list,
       cols: [[
          {field:'uid', width:80}
          ,{field:'id', width:80, title: '#',  fixed: 'left'}
          ,{field:'loginname', width:80, title: '用户名', fixed: 'left'}
          ,{field:'phone', width:80, title: '电话'}
          ,{field:'score', width:80, title: '评分'}
          ,{field:'sex', width:80, title: '性别' }
          ,{field:'Department', width:80, title: '部门'}
          ,{field:'experience', width:80, title: '积分', sort: true}
        ]]*/
     });
  },

  loadScoreAccount: function(acc,done,fail){
    $.ajax({
      url: '{:url("admin/score_account/public_get_balance",["type"=>1])}',
      type: 'get',
      dataType: 'json',
      data: {type: 1, acc:acc}
    })
    .done(function(res) {
      if(typeof(done)=="function"){
        done(res);
      }
    })
    .fail(function() {
      if(typeof(fail)=="function"){
        done();
      }
    })
    .always(function() {
    });

  }
}

RESOLVE_INIT.init();
</script>
{/block}
