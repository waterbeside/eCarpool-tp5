{extend name="base" /}
{block name="body"}
<div class="amain-body page-trip-detail">
  <div class="page-trip-detail-inner">
    <div class="trip-time">{$data.time}</div>
    <div class="trip-start-end">
      <div class="start">
        <i class='fa fa-map-marker'></i> {$data.start_addressname}
      </div>
      <div class="line">
        >
      </div>
      <div class="end">
        <i class='fa fa-map-marker'></i> {$data.end_addressname}
      </div>
    </div>
    <div class="map-content" id='map-content' >
      地图加载中。。
    </div>
    <div class="member-bar">
      <div class="member-bar-inner">
        <a class="member-item driver" href="{:url('admin/User/public_detail',['id'=>$data['driver_id']])}"   data-title="用户详情"  data-trigger="modal" title="用户详情">
          <div class="avatar" style="background-image:url('{$data.driver_avatar}')"></div>
          <div class="member-info ">
              <p class="type">司机</p>
              <p class="name layui-elip"><b title="{$data.driver_name} / {$data.driver_loginname}">{$data.driver_name}</b></p>
              <!-- <p class="loginname layui-elip"><small>{$data.driver_loginname}</small></p> -->
              <p class="phone">{$data.driver_phone}</p>
          </div>
        </a>
        {foreach name="data.passengers" item="vo"}
        <a class="member-item passenger" href="{:url('admin/User/public_detail',['id'=>$vo['uid']])}"   data-title="用户详情"  data-trigger="modal" title="用户详情">
          <div class="avatar" style="background-image:url('{$vo.avatar}')"></div>
          <div class="member-info ">
              <p class="type">乘客</p>
              <p class="name layui-elip"><b title="{$vo.name} / {$vo.loginname}">{$vo.name}</b></p>
              <p class="phone">{$vo.phone}</p>
          </div>
        </a>
        {/foreach}

      </div>
    </div>

  </div>

    <table class="info-table layui-table">
      <tbody>
        <tr>
          <td class="td-label" width="100">#</td>
          <td>{$data.love_wall_ID}</td>
        </tr>
        <tr>
          <td class="td-label">起点</td>
          <td><i class="fa fa-time"></i>{$data.start_addressname}</td>
        </tr>
        <tr>
          <td class="td-label">终点</td>
          <td>{$data.end_addressname}</td>
        </tr>
        <tr>
          <td class="td-label">出发时间</td>
          <td>{$data.time}</td>
        </tr>
        <tr>
          <td class="td-label">约车时间</td>
          <td>{$data.subtime}</td>
        </tr>
        <tr>
          <td class="td-label" width="100">司机</td>
          <td>
            {php}echo $data['driver_sex']==1 ? '<i class="fa fa-mars"></i>' : ($data['driver_sex']==2 ? '<i class="fa fa-venus"></i>' : '<i class="fa fa-genderless"></i>' );{/php}
            <a href="{:url('admin/User/public_detail',['id'=>$data['driver_id']])}"   data-title="用户详情"  data-trigger="modal" title="用户详情" style="color:#3d7ea3;">
              {$data.driver_name} ({$data.driver_loginname})
            </a>
            <p class="department">
              {$data.driver_department} / {php}echo $data['driver_companyname']!='' ? $data['driver_companyname'] : '-' ;{/php} /
              <?php echo isset($companys[$data['driver_company_id']]) ? $companys[$data['driver_company_id']] : $data['driver_company_id']; ?>
            </p>

          </td>
        </tr>
        {foreach name="data.passengers" item="vo"}
        <tr>
          <td class="td-label">乘客</td>
          <td>
            <a onclick="openParentLayer('{:url('admin/CarpoolTrips/detail',['id'=>$vo['infoid'],'type'=>0])}',{area:['500px','90%'],title:'行程：{$data.start_addressname} > {$data.end_addressname}'});" href="javascript:void(0);"  style="float:right" class="layui-btn  layui-btn-xs " >行程</a>
            {php}echo $vo['sex']==1 ? '<i class="fa fa-mars"></i>' : ($vo['sex']==2 ? '<i class="fa fa-venus"></i>' : '<i class="fa fa-genderless"></i>' );{/php}
            <a href="{:url('admin/User/public_detail',['id'=>$data['driver_id']])}"   data-title="用户详情"  data-trigger="modal" title="用户详情" style="color:#3d7ea3;">
              {$vo.name} ({$vo.loginname})
            </a>
            <p class="department">
              {$vo.department} / {php}echo $vo['companyname']!='' ? $vo['companyname'] : '-' ;{/php} /
              <?php echo isset($companys[$vo['company_id']]) ? $companys[$vo['company_id']] : $vo['company_id']; ?>
            </p>

          </td>
        </tr>
        {/foreach}


      </tbody>
    </table>


</div>

{/block}
{block name="js"}


{/block}
{block name="script"}
<script>
function showMap(targetId){
  var map = new AMap.Map(targetId, {
      // resizeEnable: true,
      //zoom:11,
      // center: [112.903921, 22.884658]
  });
	map.getCity(function(data) {
      if (data['province'] && typeof data['province'] === 'string') {
				GV['local_city'] =  data ;
          // document.getElementById('info').innerHTML = '城市：' + (data['city'] || data['province']);
      }
  });
  map.plugin('AMap.Geolocation', function() {
       geolocation = new AMap.Geolocation({
           enableHighAccuracy: true,//是否使用高精度定位，默认:true
           timeout: 10000,          //超过10秒后停止定位，默认：无穷大
           buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
           zoomToAccuracy: true,      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
           buttonPosition:null
       });
      //  map.addControl(geolocation);
       geolocation.getCurrentPosition();
			//  console.log(geolocation)
			 AMap.event.addListener(geolocation, 'complete', function(GeolocationResult){
				 GV['local_position'] = GeolocationResult.position
			 })
			 AMap.event.addListener(geolocation, 'error', function(GeolocationError){
				//  console.log(GeolocationError)
			 })
      //  AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
      //  AMap.event.addListener(geolocation, 'error', onError);      //返回定位出错信息
   });
  return map;
}


// 绘制路线
function drawRouteLine(start,end,mapObj,callBack){
  mapObj = mapObj || map;
  mapObj.clearMap();
  AMap.service('AMap.Driving',function(){ //回调函数
    //实例化Driving
    GV['map_driving']= new AMap.Driving({
          map: mapObj,
          // panel: "panel"
      });
    //TODO: 使用driving对象调用驾车路径规划相关的功能
    //传经纬度
    //  driving.search(new AMap.LngLat(116.379028, 39.865042), new AMap.LngLat(116.427281, 39.903719));
    GV['map_driving'].search(start, end, function(status, result) {
         //TODO 解析返回结果，自己生成操作界面和地图展示界面
         if(typeof(callBack)=='function'){
           callBack(status,result);
         }
         console.log(result)
    });
  });
}

var data = {
  start:["{$data.start_longtitude}","{$data.start_latitude}"],
  end:["{$data.end_longtitude}","{$data.end_latitude}"]
}
cLoadScript(GV.config.url.amapScript,function(){
  var map = showMap('map-content');
  drawRouteLine(data.start,data.end,map);
});






</script>
{/block}
