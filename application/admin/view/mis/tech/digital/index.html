{extend name="base" /}
{block name="body"}
<div class="amain-body">
    <!--tab标签-->
    <div class="layui-tab layui-tab-brief">
        <ul class="amain-tool-bar">
        <li class="layui-this"><a href="{:url('admin/mis.tech.digital/index')}">数码印花数据管理</a></li>
        <li class="btn-item btn-item-add">
            最后同步：{:date('Y-m-d H:i', strtotime($lastSyncTime))}
        </li>
        <!-- <li class="btn-item btn-item-add">
            <a class="layui-btn layui-btn-sm layui-btn-success "
            onclick="openLayer('{:url('admin/mis.tech.digital/add')}',{area: ['96%', '90%'], title:'添加数据'});"
            href="javascript:void(0);">
            <i class="fa fa-plus"></i> 添加数据</a>
        </li> -->
        <li class="btn-item btn-item-right">
            <a class="layui-btn layui-btn-sm layui-btn-success"
            id="sync-btn"
            onclick="PAGE_EXEC.sync()"
            href="javascript:void(0);">
            <i class="fa fa-refresh"></i> 同步数据</a>
        </li>
        
        <li class="btn-item btn-item-right">
            <a class="layui-btn layui-btn-sm layui-btn-primary "
            target="_blank"
            href="http://gitsite.net/e_programs/gek_tech/#/digital_printing">
            <i class="fa fa-eye"></i> 前台展示</a>
        </li>

        
        </ul>
        <div class="layui-tab-content">

        <form class="layui-form layui-form-pane" action="{:url('admin/mis.tech.digital/index')}" method="get">
            <div class="layui-inline">
            </div>
            <div class="layui-inline">
            <div class="layui-input-inline">
                <input type="text" name="filter[keyword]" value="{$filter.keyword}" placeholder="备注、进度、客户关键词" style="width:200px" title="备注、进度、客户关键词" class="layui-input">
            </div>
            <div class="layui-input-inline">
                <input type="text" name="filter[keyword2]" value="{$filter.keyword2 ?? ''}" placeholder="单号、品名、款号关键词" style="width:200px" title="备注、进度、款号关键词"  class="layui-input">
            </div>
            <div class="layui-input-inline">
                <input type="text" name="filter[batch_no]" value="{$filter.batch_no ?? ''}" placeholder="查缸号" class="layui-input">
            </div>
            <div class="layui-input-inline">
                <select name="filter[status]">
                <option value="" {if condition="!isset($filter['status']) || !is_numeric($filter['status'])" }  selected="selected" {/if}>状态：不限 </option>
                <option value="1" {if condition="isset($filter['status']) && is_numeric($filter['status']) && $filter['status'] == 1" } selected="selected" {/if}>完结 </option> 
                <option value="0" {if condition="isset($filter['status']) && is_numeric($filter['status']) && $filter['status'] == 0"  } selected="selected" {/if}>进行中 </option> 
                </select> 
            </div>
            <div class="layui-input-inline" style="width: 120px;">
                <select name="filter[bulk_sample]">
                <option value="" {if condition="!isset($filter['bulk_sample']) || !$filter['bulk_sample']" }  selected="selected" {/if}>大货样板 </option>
                <option value="样板" {if condition="isset($filter['bulk_sample']) && $filter['bulk_sample'] == '样板'" } selected="selected" {/if}>样板 </option> 
                <option value="大货" {if condition="isset($filter['bulk_sample']) && $filter['bulk_sample'] == '大货'"  } selected="selected" {/if}>大货 </option> 
                </select> 
            </div> 
            </div> 

            <div class="layui-inline">
                <button class="layui-btn">搜索</button>
            </div>
        </form>
        <hr>

        <form action="" method="post" class="ajax-form">
            <div class="layui-tab-item layui-show mis-digital-list__wrapper">
            <table class="layui-table" lay-filter="listtable">
                <thead>
                <tr>
                    <th lay-data="{field:'id', width:80, fixed:'left'}" >ID</th>
                    <th lay-data="{field:'thumb_data', width:100, fixed:'left'}" >缩图</th>
                    <th lay-data="{field:'order_date', width:160}">季度</th>
                    <th lay-data="{field:'batch_no', width:160}">缸号</th>
                    <th lay-data="{field:'remark', width:260}">备注</th>
                    <th lay-data="{field:'progress', width:240}">进度</th>
                    <th lay-data="{field:'name', width:160}">品名</th>
                    <th lay-data="{field:'order_id', width:160}">订单号</th>
                    <th lay-data="{field:'model_no', width:160}">款号</th>
                    <th lay-data="{field:'customer_name', width:160}">客户</th>
                    <th lay-data="{field:'digital_id', width:160}">印花编号</th>
                    <th lay-data="{field:'pattern', width:160}">花型</th>
                    <th lay-data="{field:'bulk_sample', width:160}">大货样板</th>
                    <th lay-data="{field:'print_mode', width:160}">打印模式</th>
                    <th lay-data="{field:'print_param', width:160}">打印参数</th>
                    <th lay-data="{field:'print_ink', width:160}">墨水用量</th>
                    
                    <th lay-data="{field:'batch_status', width:120}">缸状态</th>
                    <th lay-data="{field:'image_src', width:120}">图稿路径</th>
                    <th lay-data="{field:'options', width:100, fixed: 'right'}">操作</th>
                </tr>
                </thead>
                <tbody>
                {foreach name="lists" item="vo"}
                <tr>
                    <td>{$vo.id}</td>
                    <td>
                        <?php if(empty($vo['thumb_data'])) { ?>
                            -
                        <?php }else { ?>
                            <div class="cover-pic-wrapper"
                                style=" float: left;width:40px;height:40px;background-image:url('{$vo.thumb_fullpath}')">
                            </div>
                        <?php }?>
                    
                    </td>
                    <td>{$vo.order_date}</td>
                    <td>{$vo.batch_no}</td>
                    <td>{$vo.remark}</td>
                    <td>{$vo.progress}</td>
                    <td>{$vo.name}</td>
                    <td>{$vo.order_id}</td>
                    <td>{$vo.model_no}</td>
                    <td>{$vo.customer_name}</td>
                    <td>{$vo.digital_id}</td>
                    <td>{$vo.pattern}</td>
                    <td>{$vo.bulk_sample}</td>
                    <td>{$vo.print_mode}</td>
                    <td>{$vo.print_param}</td>
                    <td>{$vo.print_ink}</td>
                    
                    <!-- <td>{php}echo $vo['status']==1 ? '完结' : '进行中';{/php}</td> -->
                    <td>{$vo.batch_status}</td>
                    <td>{$vo.image_src}</td>
                    <td>
                    <a onclick="openLayer('{:url('admin/mis.tech.digital/edit',['id'=>$vo['id']])}',{area: ['96%', '90%'], title:'编辑数据 #{$vo.id}'});" href="javascript:void(0);" class="layui-btn layui-btn-xs " title="编辑">
                        <i class="layui-icon">&#xe642;</i>
                    </a>
                    <a href="{:url('admin/mis.tech.digital/delete',['id'=>$vo['id']])}" class="layui-btn layui-btn-primary layui-btn-xs ajax-delete" title="删除">
                        <i class="layui-icon">&#xe640;</i>
                    </a>
                    </td>
                </tr>
                {/foreach}
                </tbody>
            </table>
            <!--分页-->
            {$lists|raw}
            </div>
        </form>
        </div>
    </div>
</div>
<style>
    .mis-digital-list__wrapper .layui-table-cell {
        /* height: 60px; */
        /* white-space: nowrap; */
    }
</style>
{/block}
{block name="script"}
<script>
PAGE_EXEC = {
    
    init: function(){
        initLayuiTable({ limit: {$pagesize} })
    },
    sync: function() {
        var $btn = $('#sync-btn');
        var isLoading = $btn.data('loading');
        if (isLoading) {
            layer.msg('正在同步，请稍候');
            return false;
        }
        $btn.data('loading', true);
        var loading = layer.load(2,{ shade: [0.2,'#fff']});

        $.ajax({
            url: 'http://192.168.101.143:8031/mis/api/v1/digital/syncListAndStatus',
            method: 'get',
            dataType: 'json',
            success: function (res) {
                var code = res.code;
                if (code === 0 || code === 404) {
                    layer.msg('同步成功');
                    setTimeout(function(){
                        location.reload();
                    }, 400)
                }
                if (code === 409) {
                    layer.msg(res.msg);
                }
            },
            error: function (error) {
                layer.msg('网络不通，请注意只能在公司内网进行同步');
                
            },
            complete: function() {
                layer.close(loading);
                $btn.data('loading', false);

            }
        })
    }
}
PAGE_EXEC.init()

</script>
{/block}